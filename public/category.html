<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>카테고리 상품 목록</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      // 상품 목록을 동적으로 표시
      async function displayProducts(categoryName, searchQuery) {
        const productList = document.getElementById("product-list");
        const categoryTitle = document.getElementById("category-title");

        let url = "/api/products"; // 기본 URL

        // 카테고리나 검색어가 있으면 URL에 파라미터 추가
        if (categoryName) {
          url += `?category=${encodeURIComponent(categoryName)}`;
        } else if (searchQuery) {
          url += `?search=${encodeURIComponent(searchQuery)}`;
        }

        // 서버에서 상품 데이터 가져오기
        const response = await fetch(url);
        const products = await response.json();

        // 타이틀 설정
        categoryTitle.textContent = categoryName
          ? `${categoryName} 검색 결과`
          : `${searchQuery} 검색 결과`;

        // 기존 상품 목록 초기화
        productList.innerHTML = "";

        // 상품 데이터로 목록 생성
        products.forEach((product) => {
          const productItem = document.createElement("div");
          productItem.className = "product-item";

          // 상품 HTML 구조
          productItem.innerHTML = `
      <a href="/productDetails.html?id=${product._id}">
        <img src="${product.image}" alt="${product.name}" />
        <h3>
          ${product.name}
   <span 
            class="like-button"
            style="font-size: 24px; color: red; pointer-events: none;">★</span>
          <span class="like-count" id="like-count-${product._id}">
            ${product.likes}
          </span>
        </h3>
        <p class="price">${product.startPrice.toLocaleString()}원</p>
        <p>${product.description}</p>
      </a>
    `;

          productList.appendChild(productItem);
        });

        // 찜 버튼 클릭 이벤트 추가
        document.querySelectorAll(".like-button").forEach((button) => {
          button.addEventListener("click", async (event) => {
            event.preventDefault(); // 기본 링크 동작 방지
            const productId = button.dataset.productId;
            const userId = "로그인된사용자ID"; // 여기에 실제 로그인 사용자 ID를 추가

            try {
              const response = await fetch(`/api/products/${productId}/like`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ userId }),
              });

              if (!response.ok) {
                const errorData = await response.json();
                alert(errorData.error); // 에러 메시지 출력
                return;
              }

              const likeData = await response.json();
              // 찜 갯수 업데이트
              const likeCountElement = document.getElementById(
                `like-count-${productId}`
              );
              likeCountElement.textContent = likeData.likes;
            } catch (error) {
              console.error("찜 기능 처리 오류:", error);
            }
          });
        });
      }

      // URL에서 카테고리 가져오기
      function getCategoryFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
          category: urlParams.get("category"),
          search: urlParams.get("search"),
        };
      }

      // 페이지 로드 시 상품 표시
      document.addEventListener("DOMContentLoaded", () => {
        const { category, search } = getCategoryFromURL();

        if (search) {
          displayProducts(null, search); // 검색어만 있는 경우
        } else {
          displayProducts(category || "전체", null); // 카테고리만 있는 경우
        }
      });
    </script>

    <script>
      function goToMain() {
        window.location.href = "../index.html"; // 메인 페이지로 이동
      }
      function showMyPage() {
        window.location.href = "mypage.html"; // 마이 페이지로 이동
      }

      function goToRegister() {
        window.location.href = "registration.html";
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateAuthButton();
      });

      function updateAuthButton() {
        const token = document.cookie.includes("token");
        const authButton = document.querySelector(".login-button");

        if (token) {
          authButton.textContent = "로그아웃";
          authButton.onclick = logout;
        } else {
          authButton.textContent = "로그인";
          authButton.onclick = goToLogin;
        }
      }

      function logout() {
        fetch("/api/logout", { method: "POST" })
          .then((response) => {
            if (response.ok) {
              alert("로그아웃 성공");
              window.location.href = "../index.html";
              updateAuthButton();
            } else {
              throw new Error("로그아웃 실패");
            }
          })
          .catch((error) => console.error("로그아웃 중 오류 발생:", error));
      }
    </script>
  </head>
  <body>
    <!-- 상단 헤더 -->
    <div class="header">
      <div class="logo-container" onclick="goToMain()">
        <img
          src="./images/free-icon-auction-3211435.png"
          alt="Bid Icon"
          class="icon-small"
        />
        <span class="site-title">
          <span>거</span><span>래</span><span>해</span><span>요</span>
          <span>&nbsp;</span>
          <span>경</span><span>매</span><span>의</span><span>숲</span>
        </span>
      </div>

      <!-- 가운데 검색창 -->
      <div class="search-container">
        <input
          type="text"
          class="search-bar"
          placeholder="검색어를 입력하세요"
        />
        <span class="search-icon">🔍</span>
      </div>

      <!-- 마이페이지,로그인,상품등록 버튼 -->
      <div class="button-group">
        <button class="register" onclick="goToRegister()">상품 등록</button>
        <button class="login-button" onclick="goToLogin()">로그인</button>
        <button class="my-page" onclick="showMyPage()">마이페이지</button>
      </div>
    </div>

    <div class="container">
      <!-- 왼쪽 필터 영역 -->
      <div class="filter">
        <h3>가격 필터</h3>
        <form id="price-filter-form">
          <p>
            <label
              >0 - 1,000원<input
                type="checkbox"
                name="price-range"
                value="0-1000" /></label
            ><br />
            <label
              >1,000 - 5,000원<input
                type="checkbox"
                name="price-range"
                value="1000-5000" /></label
            ><br />
            <label
              >5,000 - 10,000원<input
                type="checkbox"
                name="price-range"
                value="5000-10000" /></label
            ><br />
            <label
              >10,000 - 100,000원<input
                type="checkbox"
                name="price-range"
                value="10000-100000" /></label
            ><br />
            <label
              >100,000 - 300,000원<input
                type="checkbox"
                name="price-range"
                value="100000-300000" /></label
            ><br />
            <button type="button" onclick="applyFilter()" class="link-button">
              적용하기
            </button>
          </p>
        </form>
        <div class="manual-price-filter">
          <label>직접 입력:</label><br />
          <input
            type="number"
            id="min-price"
            placeholder="최소가격(원)"
            style="width: 120px"
          />
          ~
          <input
            type="number"
            id="max-price"
            placeholder="최대가격(원)"
            style="width: 120px"
          /><br />
        </div>
      </div>

      <!-- 오른쪽 상품 리스트 -->
      <div class="product-container">
        <h1 id="category-title"></h1>
        <div class="product-list" id="product-list"></div>
      </div>
    </div>
  </body>
</html>
