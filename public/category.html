<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¹´í…Œê³ ë¦¬ ìƒí’ˆ ëª©ë¡</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      // ìƒí’ˆ ëª©ë¡ì„ ë™ì ìœ¼ë¡œ í‘œì‹œ
      async function displayProducts(categoryName, searchQuery, priceFilter = "") {
        const productList = document.getElementById("product-list");
        const categoryTitle = document.getElementById("category-title");

        let url = "/api/products"; // ê¸°ë³¸ URL

        // ì¹´í…Œê³ ë¦¬ë‚˜ ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ URLì— íŒŒë¼ë¯¸í„° ì¶”ê°€
        if (categoryName) {
          url += `?category=${encodeURIComponent(categoryName)}`;
        } else if (searchQuery) {
          url += `?search=${encodeURIComponent(searchQuery)}`;
        }

        // ê°€ê²© í•„í„° ì¶”ê°€
        if (priceFilter) {
          url += (url.includes("?") ? "&" : "?") + priceFilter;
        }

        // ì„œë²„ì—ì„œ ìƒí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(url);
        const products = await response.json();

        // íƒ€ì´í‹€ ì„¤ì •
        categoryTitle.textContent = categoryName
          ? `${categoryName} ê²€ìƒ‰ ê²°ê³¼`
          : `${searchQuery} ê²€ìƒ‰ ê²°ê³¼`;

        // ê¸°ì¡´ ìƒí’ˆ ëª©ë¡ ì´ˆê¸°í™”
        productList.innerHTML = "";

        // ìƒí’ˆ ë°ì´í„°ë¡œ ëª©ë¡ ìƒì„±
        products.forEach((product) => {

          const currentDateTime = new Date();
          const productEndTime = new Date(product.endTime);

          if(productEndTime > currentDateTime){
            const productItem = document.createElement("div");
          productItem.className = "product-item";

          // ìƒí’ˆ HTML êµ¬ì¡°
          productItem.innerHTML = `

            <a href="/productDetails.html?id=${product._id}">
              <img src="${product.image}" alt="${product.name}" />
              <h3>
                ${product.name}
                <span class="like-button" data-product-id="${
                  product._id
                }" style="cursor: pointer; font-size: 24px; color: red;">â˜…</span>
                <span class="like-count" id="like-count-${product._id}">${
            product.likes
          }</span>
              </h3>
              <p class="price">${product.currentPrice.toLocaleString()}ì›</p>
              <p>${product.description}</p>
            </a>
          `;

          productList.appendChild(productItem);
          }
        });
      }

      // ê°€ê²© í•„í„° ì ìš© í•¨ìˆ˜
      function applyFilter() {
        const checkedRanges = Array.from(document.querySelectorAll('input[name="price-range"]:checked'))
          .map((checkbox) => checkbox.value);

        if (checkedRanges.length === 0) {
          alert("ì ìš©í•  ê°€ê²© ë²”ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }

        // ì„ íƒëœ ê°€ê²© ë²”ìœ„ë¥¼ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬
        const urlParams = new URLSearchParams(window.location.search);
        checkedRanges.forEach((range, index) => {
          urlParams.append(`priceRange[${index}]`, range);
        });
        const category = urlParams.get("category");
        const search = urlParams.get("search");

        // ìƒí’ˆ ë‹¤ì‹œ ë¡œë“œ
        displayProducts(category, search, urlParams.toString());
      }

      // ì§ì ‘ ì…ë ¥ ê°€ê²© í•„í„° ì ìš© í•¨ìˆ˜
      function applyManualFilter() {
        const minPrice = document.getElementById("min-price").value;
        const maxPrice = document.getElementById("max-price").value;

        // ì…ë ¥ê°’ ê²€ì¦
        if (!minPrice || !maxPrice) {
          alert("ìµœì†Œ ê°€ê²©ê³¼ ìµœëŒ€ ê°€ê²©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }
        if (parseInt(minPrice) > parseInt(maxPrice)) {
          alert("ìµœì†Œ ê°€ê²©ì€ ìµœëŒ€ ê°€ê²©ë³´ë‹¤ ì‘ì•„ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        // URL íŒŒë¼ë¯¸í„° ìƒì„±
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.append("minPrice", minPrice);
        urlParams.append("maxPrice", maxPrice);

        const category = urlParams.get("category");
        const search = urlParams.get("search");

        // ìƒí’ˆ ë‹¤ì‹œ ë¡œë“œ
        displayProducts(category, search, urlParams.toString());
      }

      function resetFilter() {
        // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
        document.querySelectorAll('input[name="price-range"]').forEach((checkbox) => {
          checkbox.checked = false;
        });

        // ì§ì ‘ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById("min-price").value = "";
        document.getElementById("max-price").value = "";

        // URL íŒŒë¼ë¯¸í„° ì´ˆê¸°í™”
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.delete("minPrice");
        urlParams.delete("maxPrice");
        urlParams.delete("priceRange[0]");
        urlParams.delete("priceRange[1]"); // ì¶”ê°€ëœ ëª¨ë“  ê°€ê²© í•„í„° ì‚­ì œ

        // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë˜ëŠ” ê²€ìƒ‰ì–´ ìœ ì§€
        const category = urlParams.get("category");
        const search = urlParams.get("search");

        // ìƒí’ˆ ë‹¤ì‹œ ë¡œë“œ
        displayProducts(category, search, urlParams.toString());
      }


      // URLì—ì„œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
      function getCategoryFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
          category: urlParams.get("category"),
          search: urlParams.get("search"),
        };
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒí’ˆ í‘œì‹œ
      document.addEventListener("DOMContentLoaded", () => {
        const { category, search } = getCategoryFromURL();

        if (search) {
          displayProducts(null, search); // ê²€ìƒ‰ì–´ë§Œ ìˆëŠ” ê²½ìš°
        } else {
          displayProducts(category || "ì „ì²´", null); // ì¹´í…Œê³ ë¦¬ë§Œ ìˆëŠ” ê²½ìš°
        }
      });

      function goToMain() {
        window.location.href = "../index.html"; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      }      

      function goToRegister() {
        // /api/products/add ê²½ë¡œë¡œ GET ìš”ì²­
        fetch("/api/products/add", {
          method: "GET",
        })
          .then((response) => {
            if (response.ok) {
              // ìš”ì²­ ì„±ê³µ ì‹œ registration.htmlë¡œ ì´ë™
              window.location.href = "./registration.html";
            } else {
              // ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
              alert(
                "ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
              );
            }
          })
          .catch((error) => {
            console.error("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateAuthButton();
      });

      async function updateAuthButton() {
        const authButton = document.querySelector(".login-button");
        const buttonGroup = document.querySelector(".button-group"); // ë²„íŠ¼ ê·¸ë£¹

        // ê¸°ì¡´ ê´€ë¦¬ì ë²„íŠ¼ì´ ìˆìœ¼ë©´ ì œê±°
        const existingAdminButton = document.querySelector(".admin-button");
        if (existingAdminButton) {
          existingAdminButton.remove();
        }

        // ì¿ í‚¤ì—ì„œ í† í° ì¶”ì¶œ
        const cookieToken = document.cookie
          .split("; ")
          .find((row) => row.startsWith("token="));
        if (!cookieToken) {
          // í† í°ì´ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ë²„íŠ¼ìœ¼ë¡œ ì²˜ë¦¬
          authButton.textContent = "ë¡œê·¸ì¸";
          authButton.onclick = goToLogin;
          return;
        }

        const token = cookieToken.split("=")[1]; // í† í° ê°’ë§Œ ì¶”ì¶œ

        // í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
        const userInfo = parseJwt(token); // JWT ë””ì½”ë”©
        const userId = userInfo?.id; // id ê°’ ì¶”ì¶œ

        if (userId) {
          authButton.textContent = "ë¡œê·¸ì•„ì›ƒ";
          authButton.onclick = logout;

          try {
            // ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ìš”ì²­
            const response = await fetch(`/api/members/info?userId=${userId}`, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            });

            if (response.ok) {
              const userData = await response.json();
              console.log(userData);

              if (userData.member.is_admin) {
                // is_adminì´ trueì¼ ë•Œ ê´€ë¦¬ì ë²„íŠ¼ ì¶”ê°€
                if(!document.querySelector(".admin-button")){
                  const adminButton = document.createElement("button");
                adminButton.textContent = "ê´€ë¦¬ì í˜ì´ì§€";
                adminButton.classList.add("admin-button");
                adminButton.onclick = () => {
                  window.location.href = "/admin.html"; // ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™
                };
                buttonGroup.insertBefore(adminButton, document.getElementById("register")); // ìƒí’ˆë“±ë¡ ë²„íŠ¼ ì™¼ìª½ì— ì‚½ì…
                }
              }
            } else {
              console.error("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
          } catch (error) {
            console.error("ì‚¬ìš©ì ì •ë³´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          }
        } else {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
          authButton.textContent = "ë¡œê·¸ì¸";
          authButton.onclick = goToLogin;
        }
      }

      // JWT ë””ì½”ë”© í•¨ìˆ˜
      function parseJwt(token) {
        if (!token) {
          console.error("í† í°ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
          return null;
        }
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (error) {
          console.error("JWT íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          return null;
        }
      }

    </script>
  </head>

  <body>

    <!-- ë¡œê·¸ì¸ íŒì—… -->
    <div id="loginPopup" class="login-popup">
      <div>
        <span class="close-btn" onclick="closePopup()">âœ–</span>
        <form id="loginForm">
          <div class="form-group">
            <input type="text" id="email" placeholder="ì•„ì´ë””" required />
          </div>
          <div class="form-group password-group">
            <input
              type="password"
              id="password"
              placeholder="ë¹„ë°€ë²ˆí˜¸"
              required
            />
            <span class="password-toggle" onclick="togglePassword()">ğŸ‘ï¸</span>
          </div>
          <div class="form-group">
            <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
          </div>
          <!-- í•˜ë‹¨ ë§í¬ -->
          <div class="links">
            <a href="./public/findid.html">ì•„ì´ë””(ì´ë©”ì¼) ì°¾ê¸°</a> |
            <a href="./public/findid.html">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a> |
            <a href="./public/signup.html">íšŒì›ê°€ì…</a>
          </div>
          <strong>ê´€ë¦¬ìì•„ì´ë””: test@test.com</strong><br>
          <strong>ê´€ë¦¬ìë¹„ë°€ë²ˆí˜¸: test</strong>
        </form>
      </div>
    </div>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
      <div class="logo-container" onclick="goToMain()">
        <img
          src="./images/free-icon-auction-3211435.png"
          alt="Bid Icon"
          class="icon-small"
        />
        <span class="site-title">
          <span>ê±°</span><span>ë˜</span><span>í•´</span><span>ìš”</span>
          <span>&nbsp;</span>
          <span>ê²½</span><span>ë§¤</span><span>ì˜</span><span>ìˆ²</span>
        </span>
      </div>

      <!-- ê°€ìš´ë° ê²€ìƒ‰ì°½ -->
      <div class="search-container">
        <input
          type="text"
          id="search-bar"
          class="search-bar"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        />
        <span class="search-icon" onclick="searchProducts()">ğŸ”</span>
      </div>

      <!-- ë§ˆì´í˜ì´ì§€,ë¡œê·¸ì¸,ìƒí’ˆë“±ë¡ ë²„íŠ¼ -->
      <div class="button-group">
        <button class="register" onclick="goToRegister()">ìƒí’ˆ ë“±ë¡</button>
        <button class="login-button" onclick="goToLogin()">ë¡œê·¸ì¸</button>
        <button class="my-page" onclick="showMyPage()">ë§ˆì´í˜ì´ì§€</button>
      </div>
    </div>

    <div class="container">
      <!-- ì™¼ìª½ í•„í„° ì˜ì—­ -->
      <div class="filter">
        <h3>ê°€ê²© í•„í„°</h3>
          <form id="price-filter-form">
            <p>
            <label>0 - 1,000ì›<input type="checkbox" name="price-range" value="0-1000" /></label>
            <label>1,000 - 5,000ì›<input type="checkbox" name="price-range" value="1000-5000" /></label>
            <label>5,000 - 10,000ì›<input type="checkbox" name="price-range" value="5000-10000" /></label>
            <label>10,000 - 100,000ì›<input type="checkbox" name="price-range" value="10000-100000" /></label>
            <label>100,000 - 300,000ì›<input type="checkbox" name="price-range" value="100000-300000" /></label>
            <button type="button" onclick="applyFilter()" class="link-button">
              ì ìš©í•˜ê¸°
            </button>            
          </p>
          </form>
          <div class="manual-price-filter">
            <label>ì§ì ‘ ì…ë ¥:</label><br />
            <input
            type="number"
            id="min-price"
            placeholder="ìµœì†Œê°€ê²©(ì›)"
            style="width: 120px"
          />
          ~
          <input
            type="number"
            id="max-price"
            placeholder="ìµœëŒ€ê°€ê²©(ì›)"
            style="width: 120px"
          /><br />
          <button type="button" onclick="applyManualFilter()">ì ìš©í•˜ê¸°</button>
          <button type="button" onclick="resetFilter()">ì´ˆê¸°í™”</button>
          </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ -->
      <div class="product-container">
        <h1 id="category-title"></h1>
        <div class="product-list" id="product-list"></div>
      </div>
    </div>
    <!-- ì™¼ìª½ ì—¬ë°±ì— ë¬¼ìŒí‘œ ë²„íŠ¼ ì¶”ê°€ -->
    <div class="left-sidebar">
      <img
        src="./images/ë¬¼ìŒí‘œ.png"
        alt="Icon 1"
        onclick="showPopup('ğŸŒ³ìƒí’ˆ ì¹´í…Œê³ ë¦¬ğŸŒ³')"
      />
      <div class="text-box">
        <span class="blink-text">ë¬¼ìŒí‘œë¥¼ í´ë¦­í•´ë³´ì„¸ìš”!</span>
      </div>
    </div>

    <!-- íŒì—…ì°½ -->
    <div class="overlay" id="popupOverlay" onclick="hidePopup()"></div>
    <div class="popup" id="popupContent">
      <h2 id="popupText"></h2>
      <p>
        ì›í•˜ëŠ” ìƒí’ˆì„ ë” ì‰½ê³  ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆëŠ” ìƒí’ˆ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ì…ë‹ˆë‹¤!
        <br />
        ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë‹¤ì–‘í•œ ìƒí’ˆì„ ë‘˜ëŸ¬ë³´ì„¸ìš”!<br />
      </p>
      <p><strong>ğŸ’¡ ì£¼ìš” ê¸°ëŠ¥</strong></p>
      <ul>
        <li>
          ğŸ’°<strong>ê°€ê²© í•„í„°:</strong> ì›í•˜ëŠ” ê°€ê²©ëŒ€ì— ë§ëŠ” ìƒí’ˆì„ í•„í„°ë§í•˜ì—¬
          í™•ì¸
        </li>
        <li>â¤ï¸<strong>ì°œ ê°¯ìˆ˜ í™•ì¸:</strong> ìƒí’ˆì˜ ì¸ê¸°ë„ë¥¼ í™•ì¸</li>
        <li>ğŸ“‹<strong>ìƒí’ˆ ì„¤ëª…:</strong> ê° ìƒí’ˆì˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸</li>
      </ul>

      <button onclick="hidePopup()">ë‹«ê¸°</button>
    </div>

    <script>
      
      // íŒì—… ì—´ê¸°
      function showPopup(content) {
        document.getElementById("popupText").innerText = content;
        document.getElementById("popupOverlay").style.display = "block";
        document.getElementById("popupContent").style.display = "block";
      }

      // íŒì—… ë‹«ê¸°
      function hidePopup() {
        document.getElementById("popupOverlay").style.display = "none";
        document.getElementById("popupContent").style.display = "none";
      }

      // ë¡œê·¸ì¸ íŒì—… ë‹«ê¸°
      function closePopup() {
        document.getElementById("loginPopup").style.display = "none";
      }

      // ë§ˆì´í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
      function showMyPage() {
        // /api/products/add ê²½ë¡œë¡œ GET ìš”ì²­
        fetch("/api/mypage", {
          method: "GET",
        })
          .then((response) => {
            if (response.ok) {
              // ìš”ì²­ ì„±ê³µ ì‹œ registration.htmlë¡œ ì´ë™
              window.location.href = "./mypage.html";
            } else {
              // ìš”ì²­ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë©”ì‹œì§€ ì²˜ë¦¬
              alert("ë§ˆì´ í˜ì´ì§€ë¡œ ì´ë™í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
          })
          .catch((error) => {
            console.error("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          });
      }

      function goToLogin() {
        document.getElementById("loginPopup").style.display = "flex";
      }

      // ë¡œê·¸ì¸ í¼ ì œì¶œ ì²˜ë¦¬
      document
        .getElementById("loginForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;
          const redirectUrl = window.location.href; // í˜„ì¬ í˜ì´ì§€ URL ì €ì¥
          

          // ë¡œê·¸ì¸ ìš”ì²­ ì²˜ë¦¬ (ì˜ˆ: ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡)
          fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          })
            .then((response) => {
              if (response.ok) {
                alert("ë¡œê·¸ì¸ ì„±ê³µ!");
                closePopup(); // íŒì—… ë‹«ê¸°
                updateAuthButton();
              } else {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨. ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
              }
            })
            .catch((error) => console.error("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
        });

      function logout() {
        fetch("/api/logout", { method: "POST" })
          .then((response) => {
            if (response.ok) {
              alert("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");
              window.location.href = "../index.html";
              updateAuthButton();
            } else {
              throw new Error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
            }
          })
          .catch((error) => console.error("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
      }

      // Enter í‚¤ë¡œ ê²€ìƒ‰
      document.getElementById("search-bar").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
          event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€ (í¼ ì œì¶œ ë°©ì§€)
          searchProducts(); // ê²€ìƒ‰ í•¨ìˆ˜ í˜¸ì¶œ
        }
      });

      function searchProducts() {
        const query = document.getElementById("search-bar").value.trim();

        if (query) {
          // ê²€ìƒ‰ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒí’ˆ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¡œë“œ
          displayProducts(null, query);
          history.pushState({}, '', `?search=${encodeURIComponent(query)}`); // URL ì—…ë°ì´íŠ¸
        } else {
          alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        }
      }
    </script>
  </body>
</html>
