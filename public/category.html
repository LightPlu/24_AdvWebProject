<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì¹´í…Œê³ ë¦¬ ìƒí’ˆ ëª©ë¡</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      // ìƒí’ˆ ëª©ë¡ì„ ë™ì ìœ¼ë¡œ í‘œì‹œ
      async function displayProducts(categoryName, searchQuery) {
        const productList = document.getElementById("product-list");
        const categoryTitle = document.getElementById("category-title");

        let url = "/api/products"; // ê¸°ë³¸ URL

        // ì¹´í…Œê³ ë¦¬ë‚˜ ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ URLì— íŒŒë¼ë¯¸í„° ì¶”ê°€
        if (categoryName) {
          url += `?category=${encodeURIComponent(categoryName)}`;
        } else if (searchQuery) {
          url += `?search=${encodeURIComponent(searchQuery)}`;
        }

        // ì„œë²„ì—ì„œ ìƒí’ˆ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(url);
        const products = await response.json();

        // íƒ€ì´í‹€ ì„¤ì •
        categoryTitle.textContent = categoryName
          ? `${categoryName} ê²€ìƒ‰ ê²°ê³¼`
          : `${searchQuery} ê²€ìƒ‰ ê²°ê³¼`;

        // ê¸°ì¡´ ìƒí’ˆ ëª©ë¡ ì´ˆê¸°í™”
        productList.innerHTML = "";

        // ìƒí’ˆ ë°ì´í„°ë¡œ ëª©ë¡ ìƒì„±
        products.forEach((product) => {
          const productItem = document.createElement("div");
          productItem.className = "product-item";

          // ìƒí’ˆ HTML êµ¬ì¡°
          productItem.innerHTML = `

            <a href="/productDetails.html?id=${product._id}">
              <img src="${product.image}" alt="${product.name}" />
              <h3>
                ${product.name}
                <span class="like-button" data-product-id="${
                  product._id
                }" style="cursor: pointer; font-size: 24px; color: red;">â˜…</span>
                <span class="like-count" id="like-count-${product._id}">${
            product.likes
          }</span>
              </h3>
              <p class="price">${product.currentPrice.toLocaleString()}ì›</p>
              <p>${product.description}</p>
            </a>
          `;

          productList.appendChild(productItem);
        });
      }

      // URLì—ì„œ ì¹´í…Œê³ ë¦¬ ê°€ì ¸ì˜¤ê¸°
      function getCategoryFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
          category: urlParams.get("category"),
          search: urlParams.get("search"),
        };
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒí’ˆ í‘œì‹œ
      document.addEventListener("DOMContentLoaded", () => {
        const { category, search } = getCategoryFromURL();

        if (search) {
          displayProducts(null, search); // ê²€ìƒ‰ì–´ë§Œ ìˆëŠ” ê²½ìš°
        } else {
          displayProducts(category || "ì „ì²´", null); // ì¹´í…Œê³ ë¦¬ë§Œ ìˆëŠ” ê²½ìš°
        }
      });

      function goToMain() {
        window.location.href = "../index.html"; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      }
      function showMyPage() {
        window.location.href = "mypage.html"; // ë§ˆì´ í˜ì´ì§€ë¡œ ì´ë™
      }

      function goToRegister() {
        window.location.href = "registration.html";
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateAuthButton();
      });

      function updateAuthButton() {
        const token = document.cookie.includes("token");
        const authButton = document.querySelector(".login-button");

        if (token) {
          authButton.textContent = "ë¡œê·¸ì•„ì›ƒ";
          authButton.onclick = logout;
        } else {
          authButton.textContent = "ë¡œê·¸ì¸";
          authButton.onclick = goToLogin;
        }
      }

      function logout() {
        fetch("/api/logout", { method: "POST" })
          .then((response) => {
            if (response.ok) {
              alert("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");
              window.location.href = "../index.html";
              updateAuthButton();
            } else {
              throw new Error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
            }
          })
          .catch((error) => console.error("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
      }
    </script>
  </head>

  <body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
      <div class="logo-container" onclick="goToMain()">
        <img
          src="./images/free-icon-auction-3211435.png"
          alt="Bid Icon"
          class="icon-small"
        />
        <span class="site-title">
          <span>ê±°</span><span>ë˜</span><span>í•´</span><span>ìš”</span>
          <span>&nbsp;</span>
          <span>ê²½</span><span>ë§¤</span><span>ì˜</span><span>ìˆ²</span>
        </span>
      </div>

      <!-- ê°€ìš´ë° ê²€ìƒ‰ì°½ -->
      <div class="search-container">
        <input
          type="text"
          class="search-bar"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        />
        <span class="search-icon">ğŸ”</span>
      </div>

      <!-- ë§ˆì´í˜ì´ì§€,ë¡œê·¸ì¸,ìƒí’ˆë“±ë¡ ë²„íŠ¼ -->
      <div class="button-group">
        <button class="register" onclick="goToRegister()">ìƒí’ˆ ë“±ë¡</button>
        <button class="login-button" onclick="goToLogin()">ë¡œê·¸ì¸</button>
        <button class="my-page" onclick="showMyPage()">ë§ˆì´í˜ì´ì§€</button>
      </div>
    </div>

    <div class="container">
      <!-- ì™¼ìª½ í•„í„° ì˜ì—­ -->
      <div class="filter">
        <h3>ê°€ê²© í•„í„°</h3>
        <form id="price-filter-form">
          <p>
            <label
              >0 - 1,000ì›<input
                type="checkbox"
                name="price-range"
                value="0-1000" /></label
            ><br />
            <label
              >1,000 - 5,000ì›<input
                type="checkbox"
                name="price-range"
                value="1000-5000" /></label
            ><br />
            <label
              >5,000 - 10,000ì›<input
                type="checkbox"
                name="price-range"
                value="5000-10000" /></label
            ><br />
            <label
              >10,000 - 100,000ì›<input
                type="checkbox"
                name="price-range"
                value="10000-100000" /></label
            ><br />
            <label
              >100,000 - 300,000ì›<input
                type="checkbox"
                name="price-range"
                value="100000-300000" /></label
            ><br />
            <button type="button" onclick="applyFilter()" class="link-button">
              ì ìš©í•˜ê¸°
            </button>
          </p>
        </form>
        <div class="manual-price-filter">
          <label>ì§ì ‘ ì…ë ¥:</label><br />
          <input
            type="number"
            id="min-price"
            placeholder="ìµœì†Œê°€ê²©(ì›)"
            style="width: 120px"
          />
          ~
          <input
            type="number"
            id="max-price"
            placeholder="ìµœëŒ€ê°€ê²©(ì›)"
            style="width: 120px"
          /><br />
        </div>
      </div>

      <!-- ì˜¤ë¥¸ìª½ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ -->
      <div class="product-container">
        <h1 id="category-title"></h1>
        <div class="product-list" id="product-list"></div>
      </div>
    </div>
    <!-- ì™¼ìª½ ì—¬ë°±ì— ë¬¼ìŒí‘œ ë²„íŠ¼ ì¶”ê°€ -->
    <div class="left-sidebar">
      <img
        src="./images/ë¬¼ìŒí‘œ.png"
        alt="Icon 1"
        onclick="showPopup('ğŸŒ³ìƒí’ˆ ì¹´í…Œê³ ë¦¬ğŸŒ³')"
      />
      <div class="text-box">
        <span class="blink-text">ë¬¼ìŒí‘œë¥¼ í´ë¦­í•´ë³´ì„¸ìš”!</span>
      </div>
    </div>

    <!-- íŒì—…ì°½ -->
    <div class="overlay" id="popupOverlay" onclick="hidePopup()"></div>
    <div class="popup" id="popupContent">
      <h2 id="popupText"></h2>
      <p>
        ì›í•˜ëŠ” ìƒí’ˆì„ ë” ì‰½ê³  ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆëŠ” ìƒí’ˆ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ì…ë‹ˆë‹¤!
        <br />
        ì¹´í…Œê³ ë¦¬ë³„ë¡œ ë‹¤ì–‘í•œ ìƒí’ˆì„ ë‘˜ëŸ¬ë³´ì„¸ìš”!<br />
      </p>
      <p><strong>ğŸ’¡ ì£¼ìš” ê¸°ëŠ¥</strong></p>
      <ul>
        <li>
          ğŸ’°<strong>ê°€ê²© í•„í„°:</strong> ì›í•˜ëŠ” ê°€ê²©ëŒ€ì— ë§ëŠ” ìƒí’ˆì„ í•„í„°ë§í•˜ì—¬
          í™•ì¸
        </li>
        <li>â¤ï¸<strong>ì°œ ê°¯ìˆ˜ í™•ì¸:</strong> ìƒí’ˆì˜ ì¸ê¸°ë„ë¥¼ í™•ì¸</li>
        <li>ğŸ“‹<strong>ìƒí’ˆ ì„¤ëª…:</strong> ê° ìƒí’ˆì˜ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸</li>
      </ul>

      <button onclick="hidePopup()">ë‹«ê¸°</button>
    </div>

    <script>
      // íŒì—… ì—´ê¸°
      function showPopup(content) {
        document.getElementById("popupText").innerText = content;
        document.getElementById("popupOverlay").style.display = "block";
        document.getElementById("popupContent").style.display = "block";
      }

      // íŒì—… ë‹«ê¸°
      function hidePopup() {
        document.getElementById("popupOverlay").style.display = "none";
        document.getElementById("popupContent").style.display = "none";
      }
    </script>
  </body>
</html>
