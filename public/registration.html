<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ìƒí’ˆ ë“±ë¡</title>
    <link rel="stylesheet" href="styles.css" />
    <script>
      function goToMain() {
        window.location.href = "../index.html"; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      }
      function showMyPage() {
        window.location.href = "mypage.html"; // ë§ˆì´ í˜ì´ì§€ë¡œ ì´ë™
      }

      function goToRegister() {
        window.location.href = "registration.html";
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateAuthButton();
      });

      function updateAuthButton() {
        const token = document.cookie.includes("token");
        const authButton = document.querySelector(".login-button");

        if (token) {
          authButton.textContent = "ë¡œê·¸ì•„ì›ƒ";
          authButton.onclick = logout;
        } else {
          authButton.textContent = "ë¡œê·¸ì¸";
          authButton.onclick = goToLogin;
        }
      }

      function logout() {
        fetch("/api/logout", { method: "POST" })
          .then((response) => {
            if (response.ok) {
              alert("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");
              window.location.href = "../index.html";
              updateAuthButton();
            } else {
              throw new Error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
            }
          })
          .catch((error) => console.error("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
      }
    </script>
  </head>
  <body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
      <div class="logo-container" onclick="goToMain()">
        <img
          src="./images/free-icon-auction-3211435.png"
          alt="Bid Icon"
          class="icon-small"
        />
        <span class="site-title">
          <span>ê±°</span><span>ë˜</span><span>í•´</span><span>ìš”</span>
          <span>&nbsp;</span>
          <span>ê²½</span><span>ë§¤</span><span>ì˜</span><span>ìˆ²</span>
        </span>
      </div>

      <!-- ê°€ìš´ë° ê²€ìƒ‰ì°½ -->
      <div class="search-container">
        <input
          type="text"
          class="search-bar"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        />
        <span class="search-icon">ğŸ”</span>
      </div>

      <!-- ë§ˆì´í˜ì´ì§€,ë¡œê·¸ì¸,ìƒí’ˆë“±ë¡ ë²„íŠ¼ -->
      <div class="button-group">
        <button class="register" onclick="goToRegister()">ìƒí’ˆ ë“±ë¡</button>
        <button class="login-button" onclick="goToLogin()">ë¡œê·¸ì¸</button>
        <button class="my-page" onclick="showMyPage()">ë§ˆì´í˜ì´ì§€</button>
      </div>
    </div>

    <div class="form-container">
      <header>
        <h1>ìƒí’ˆ ë“±ë¡</h1>
      </header>
      <form id="productForm" enctype="multipart/form-data">
        <label for="name">âœ”ï¸ ìƒí’ˆëª…</label>
        <input
          type="text"
          id="name"
          name="name"
          placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
          required
        />

        <label for="productImage">âœ”ï¸ ìƒí’ˆ ì´ë¯¸ì§€</label>
        <input
          type="file"
          id="productImage"
          name="productImage"
          accept="image/*"
        />

        <label for="startPrice">âœ”ï¸ ê²½ë§¤ ì‹œì‘ ê°€ê²©</label>
        <input
          type="number"
          id="startPrice"
          name="startPrice"
          placeholder="ê²½ë§¤ ì‹œì‘ ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”"
          required
        />

        <label for="description">âœ”ï¸ ìƒí’ˆ ì„¤ëª…</label>
        <textarea
          id="description"
          name="description"
          placeholder="ìƒí’ˆì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”(20ì ë‚´ì™¸)"
        ></textarea>

        <label for="category">âœ”ï¸ ì¹´í…Œê³ ë¦¬</label>
        <select id="category" name="category" required>
          <option value="ì˜ë¥˜">ì˜ë¥˜</option>
          <option value="ê°€ì „ì œí’ˆ">ê°€ì „ì œí’ˆ</option>
          <option value="ìƒí•„í’ˆ">ìƒí•„í’ˆ</option>
          <option value="ë·°í‹°/ë¯¸ìš©">ë·°í‹°/ë¯¸ìš©</option>
          <option value="ì‹í’ˆ">ì‹í’ˆ</option>
          <option value="ê°€êµ¬">ê°€êµ¬</option>
          <option value="ë„ì„œ">ë„ì„œ</option>
          <option value="ë°˜ë ¤ë™ë¬¼ìš©í’ˆ">ë°˜ë ¤ë™ë¬¼ìš©í’ˆ</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>

        <label>âœ”ï¸ ìƒíƒœ</label>
        <div class="radio-group">
          <label
            ><input type="radio" name="status" value="new" required /> ì‹ ê·œ
            ì œí’ˆ</label
          >
          <label
            ><input type="radio" name="status" value="used" required /> ì¤‘ê³ 
            ì œí’ˆ</label
          >
        </div>

        <label for="endTime">âœ”ï¸ ê²½ë§¤ ì¢…ë£Œ ì‹œê°„</label>
        <input type="datetime-local" id="endTime" name="endTime" required />

        <button type="submit" class="register-button">ë“±ë¡</button>
      </form>
    </div>

    <!-- ì™¼ìª½ ì—¬ë°±ì— ë¬¼ìŒí‘œ ë²„íŠ¼ ì¶”ê°€ -->
    <div class="left-sidebar">
      <img
        src="./images/ë¬¼ìŒí‘œ.png"
        alt="Icon 1"
        onclick="showPopup('ğŸŒ³ìƒí’ˆ ë“±ë¡ğŸŒ³')"
      />
      <div class="text-box">
        <span class="blink-text">ë¬¼ìŒí‘œë¥¼ í´ë¦­í•´ë³´ì„¸ìš”!</span>
      </div>
    </div>

    <!-- íŒì—…ì°½ -->
    <div class="overlay" id="popupOverlay" onclick="hidePopup()"></div>
    <div class="popup" id="popupContent">
      <h2 id="popupText"></h2>
      <p>
        ê²½ë§¤ì— ë“±ë¡í•˜ê³  ì‹¶ì€ ìƒí’ˆì„ ì‰½ê³  ë¹ ë¥´ê²Œ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” "ìƒí’ˆ ë“±ë¡"
        í˜ì´ì§€ì…ë‹ˆë‹¤!<br />
        ì§€ê¸ˆ ë°”ë¡œ ìƒí’ˆì„ ë“±ë¡í•˜ê³  ê²½ë§¤ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!<br />
      </p>
      <p><strong>âš ï¸ì£¼ì˜ì‚¬í•­ </strong></p>
      <ul>
        <li>â­<strong>ê° í•­ëª©ì€ ë¹ ì§ì—†ì´, ì •í™•í•˜ê²Œ ëª¨ë‘ ê¸°ì¬</strong></li>

        <li>â­<strong>ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ì€ ë‚´ì¼ ë‚ ì§œë¶€í„° ê°€ëŠ¥</strong></li>
      </ul>

      <button onclick="hidePopup()">ë‹«ê¸°</button>
    </div>

    <script>
      // íŒì—… ì—´ê¸°
      function showPopup(content) {
        document.getElementById("popupText").innerText = content;
        document.getElementById("popupOverlay").style.display = "block";
        document.getElementById("popupContent").style.display = "block";
      }

      // íŒì—… ë‹«ê¸°
      function hidePopup() {
        document.getElementById("popupOverlay").style.display = "none";
        document.getElementById("popupContent").style.display = "none";
      }

      // í˜„ì¬ ë‚ ì§œì™€ ì‹œê°„ì„ ê°€ì ¸ì˜¤ê¸°
      const now = new Date();

      // ë‚´ì¼ ë‚ ì§œë¥¼ ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (yyyy-MM-ddTHH:mm)
      const isoNow = new Date(
        now.getTime() - now.getTimezoneOffset() * 60000
      )
        .toISOString()
        .slice(0, 16);

      // <input> í•„ë“œ ê°€ì ¸ì˜¤ê¸°
      const endTimeInput = document.getElementById("endTime");

      // ì…ë ¥ í•„ë“œì— ìµœì†Œê°’ìœ¼ë¡œ ë‚´ì¼ ë‚ ì§œ ì„¤ì •
      endTimeInput.setAttribute("min", isoNow);
    </script>

    <script>

      document.addEventListener("DOMContentLoaded", async () => {
          const token = document.cookie
            .split("; ")
            .find((row) => row.startsWith("token="))
            ?.split("=")[1];

            function parseJwt(token) {
              const base64Url = token.split(".")[1]; // JWTì˜ í˜ì´ë¡œë“œ ë¶€ë¶„
              const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
              const jsonPayload = decodeURIComponent(
                atob(base64)
                  .split("")
                  .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
                  .join("")
              );
              return JSON.parse(jsonPayload); // JSON ê°ì²´ë¡œ ë°˜í™˜
            }

      // JWT í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ í•´ì„
      const memberInfo = parseJwt(token); // ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
      const memberId = memberInfo.id; // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
      document
        .getElementById("productForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();

          const formData = new FormData(document.getElementById("productForm"));
          formData.append("memberId", memberId);

          try {
            const response = await fetch(
              "http://localhost:3000/api/products/add",
              {
                method: "POST",
                body: formData,
              }
            );

            const result = await response.json();
            if (response.ok) {
              alert(result.message); // ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥
              window.location.href = "../index.html";
            } else {
              alert(`ì˜¤ë¥˜: ${result.message}`); // ì‹¤íŒ¨ ë©”ì‹œì§€ ì¶œë ¥
            }
          } catch (error) {
            console.error(error);
            alert("ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });
      }
      )

    </script>
  </body>
</html>
