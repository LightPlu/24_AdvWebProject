<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>ìƒí’ˆ ìƒì„¸ ì •ë³´</title>
    
  </head>
  <body>
    <!-- ë¡œê·¸ì¸ íŒì—… -->
    <div id="loginPopup" class="login-popup">
      <div>
        <span class="close-btn" onclick="closePopup()">âœ–</span>
        <form id="loginForm">
          <div class="form-group">
            <input type="text" id="email" placeholder="ì•„ì´ë””" required />
          </div>
          <div class="form-group password-group">
            <input
              type="password"
              id="password"
              placeholder="ë¹„ë°€ë²ˆí˜¸"
              required
            />
            <span class="password-toggle" onclick="togglePassword()">ğŸ‘ï¸</span>
          </div>
          <div class="form-group">
            <button type="submit" class="login-btn">ë¡œê·¸ì¸</button>
          </div>
          <!-- í•˜ë‹¨ ë§í¬ -->
          <div class="links">
            <a href="/find-id">ì•„ì´ë””(ì´ë©”ì¼) ì°¾ê¸°</a> |
            <a href="/find-password">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</a> |
            <a href="./public/signup.html">íšŒì›ê°€ì…</a>
          </div>
        </form>
      </div>
    </div>


    <div class="header">
      <div class="logo-container" onclick="goToMain()">
        <img
          src="./images/free-icon-auction-3211435.png"
          alt="Bid Icon"
          class="icon-small"
        />
        <span class="site-title">
          <span>ê±°</span><span>ë˜</span><span>í•´</span><span>ìš”</span>
          <span>&nbsp;</span>
          <span>ê²½</span><span>ë§¤</span><span>ì˜</span><span>ìˆ²</span>
        </span>
      </div>

      <!-- ê°€ìš´ë° ê²€ìƒ‰ì°½ -->
      <div class="search-container">
        <input
          type="text"
          class="search-bar"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
        />
        <span class="search-icon">ğŸ”</span>
      </div>

      <!-- ë§ˆì´í˜ì´ì§€,ë¡œê·¸ì¸,ìƒí’ˆë“±ë¡ ë²„íŠ¼ -->
      <div class="button-group">
        <button class="register" onclick="goToRegister()">ìƒí’ˆ ë“±ë¡</button>
        <button class="login-button" onclick="goToLogin()">ë¡œê·¸ì¸</button>
        <button class="my-page" onclick="showMyPage()">ë§ˆì´í˜ì´ì§€</button>
      </div>
    </div>


    <div id="product-details" class="product-details-container">
      <div id="product-info"></div>
    </div>

    <!-- Left Sidebar -->
    <div class="left-sidebar">
      <img
        src="./images/ë¬¼ìŒí‘œ.png"
        alt="Icon 1"
        onclick="showPopup('ğŸŒ³ìƒì„¸í˜ì´ì§€ğŸŒ³')"
      />
      <div class="text-box">
        <span class="blink-text">ë¬¼ìŒí‘œë¥¼ í´ë¦­í•´ë³´ì„¸ìš”!</span>
      </div>
    </div>

    <!-- Popup -->
    <div class="overlay" id="popupOverlay" onclick="hidePopup()"></div>
    <div class="popup" id="popupContent">
      <h2 id="popupText"></h2>
      <p>
        ìƒí’ˆì˜ ì´ë¯¸ì§€, ì„¤ëª…, ê°€ê²©, ìƒíƒœ, ì¹´í…Œê³ ë¦¬ ë“± êµ¬ë§¤ë¥¼ ê²°ì •í•˜ê¸° ìœ„í•œ ëª¨ë“ 
        ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤. </br>
        ì›í•˜ëŠ” ìƒí’ˆì„ ì°œí•˜ê³  ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”!ğŸ’¡
      </p>
      <p><strong>â“ ì´ìš©ë°©ë²•</strong></p>
      <ul>
        <li>
          â­
          <strong
            >ì›í•˜ëŠ” ê¸ˆì•¡ì„ ì…ì°° (ë‹¨, ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ ê°€ê²©ë³´ë‹¤ ë†’ì•„ì•¼
            í•©ë‹ˆë‹¤.)</strong
          >
        </li>
        <li>
          â­ <strong>ê²½ë§¤ ì¢…ë£Œ ì‹œê°„ê¹Œì§€ ê³„ì†í•´ì„œ ì…ì°°ì´ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤.</strong>
        </li>
        <li>
          â­
          <strong
            >ê²½ë§¤ ì¢…ë£Œ í›„, ê°€ì¥ ë†’ì€ ì…ì°°ê°€ë¥¼ ì œì‹œí•œ ì‚¬ëŒì´ ë‚™ì°°ìê°€
            ë©ë‹ˆë‹¤!</strong
          >
        </li>
      </ul>

      <button onclick="hidePopup()">ë‹«ê¸°</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>

      function goToMain() {
        window.location.href = "../index.html"; // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
      }
      function showMyPage() {
        window.location.href = "mypage.html"; // ë§ˆì´ í˜ì´ì§€ë¡œ ì´ë™
      }

      function goToRegister() {
        window.location.href = "registration.html";
      }

      // íŒì—… ì—´ê¸°
      function goToLogin() {
        document.getElementById("loginPopup").style.display = "flex";
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateAuthButton();
      });

function updateCountdownTimer(endTime) {
  const timerElement = document.getElementById("countdown-timer");
  
  function calculateTimeLeft() {
    const now = new Date();
    const endDate = new Date(endTime);
    const timeLeft = endDate - now;

    if (timeLeft <= 0) {
      timerElement.textContent = "ê²½ë§¤ ì¢…ë£Œë¨";
      clearInterval(timerInterval); // íƒ€ì´ë¨¸ ì¤‘ì§€
      return;
    }

    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

    timerElement.textContent = `ë‚¨ì€ ì‹œê°„: ${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
  }

  calculateTimeLeft(); // ì²˜ìŒ í•œ ë²ˆ ì¦‰ì‹œ ì‹¤í–‰
  const timerInterval = setInterval(calculateTimeLeft, 1000); // 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
}



      function updateAuthButton() {
        const token = document.cookie.includes("token");
        const authButton = document.querySelector(".login-button");

        if (token) {
          authButton.textContent = "ë¡œê·¸ì•„ì›ƒ";
          authButton.onclick = logout;
        } else {
          authButton.textContent = "ë¡œê·¸ì¸";
          authButton.onclick = goToLogin;
        }
      }

      // ë¡œê·¸ì¸ í¼ ì œì¶œ ì²˜ë¦¬
      document
        .getElementById("loginForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          // ë¡œê·¸ì¸ ìš”ì²­ ì²˜ë¦¬ (ì˜ˆ: ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡)
          fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          })
            .then((response) => {
              if (response.ok) {
                alert("ë¡œê·¸ì¸ ì„±ê³µ!");
                closePopup(); // íŒì—… ë‹«ê¸°
                updateAuthButton();
              } else {
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨. ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
              }
            })
            .catch((error) => console.error("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
        });

      function logout() {
        fetch("/api/logout", { method: "POST" })
          .then((response) => {
            if (response.ok) {
              alert("ë¡œê·¸ì•„ì›ƒ ì„±ê³µ");
              window.location.href = "../index.html";
              updateAuthButton();
            } else {
              throw new Error("ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨");
            }
          })
          .catch((error) => console.error("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error));
      }


      // íŒì—… ì—´ê¸°
      function showPopup(content) {
        document.getElementById("popupText").innerText = content;
        document.getElementById("popupOverlay").style.display = "block";
        document.getElementById("popupContent").style.display = "block";
      }

      // íŒì—… ë‹«ê¸°
      function hidePopup() {
        document.getElementById("popupOverlay").style.display = "none";
        document.getElementById("popupContent").style.display = "none";
      }

      function parseJwt(token) {
        const base64Url = token.split(".")[1]; // JWTì˜ í˜ì´ë¡œë“œ ë¶€ë¶„
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
            .join("")
        );
        return JSON.parse(jsonPayload); // JSON ê°ì²´ë¡œ ë°˜í™˜
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const productId = new URLSearchParams(window.location.search).get("id");
        const token = document.cookie
          .split("; ")
          .find((row) => row.startsWith("token="))
          ?.split("=")[1];

        if (!productId || !token) {
          document.getElementById("product-info").innerHTML =
            "<p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>";
          return;
        }

        // JWT í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ í•´ì„
        const userInfo = parseJwt(token); // ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
        const userId = userInfo.id; // ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°

        // Socket.IO ì´ˆê¸°í™” ë° ì—°ê²°
        const socket = io({
          auth: {
            token: token,
          },
        });

        // ìƒí’ˆ ë°©ì— ì°¸ì—¬
        socket.emit("joinRoom", productId);

        try {
          const response = await fetch(`/api/Products/${productId}`);
          if (!response.ok)
            throw new Error("ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");

          const product = await response.json();

          document.getElementById("product-info").innerHTML = `

    <img src="${product.image}" alt="${product.name}" />
    <div class="product-title-container">
      <h1>${product.name}</h1>
      <div class="like-section">
        <span class="like-button" id="like-button">â˜…</span>
        <span id="like-count">${product.likes}</span>
      </div>
    </div>
    <p>${product.description}</p>
    <p id="current-price">í˜„ì¬ ê°€ê²©: ${product.currentPrice.toLocaleString()}ì›</p>
    <p>ì¹´í…Œê³ ë¦¬: ${product.category}</p>
    <p>ìƒíƒœ: ${product.status === "new" ? "ìƒˆìƒí’ˆ" : "ì¤‘ê³ "}</p>
    <p>
  ê²½ë§¤ ì¢…ë£Œ ì‹œê°„: ${new Date(product.endTime).toLocaleString()}
  <span id="countdown-timer">ë‚¨ì€ ì‹œê°„: ê³„ì‚° ì¤‘...</span>
</p>
    <div class="product-details-bid-section">
      <input type="number" id="bid-amount" class="product-details-bid-input" placeholder="ì…ì°° ê¸ˆì•¡ ì…ë ¥" />
      <button id="bid-button" class="product-details-bid-button">ì…ì°°í•˜ê¸°</button>
    </div>
    <div class="back-link-container">
  <a href="/category.html?category=${product.category}">ë’¤ë¡œê°€ê¸°</a>
</div>
  </div>
`;

updateCountdownTimer(product.endTime);



          const likeButton = document.getElementById("like-button");
          const likeCount = document.getElementById("like-count");

          // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
          const isLiked = product.likedBy && product.likedBy.includes(userId);
          if (isLiked) {
            likeButton.classList.add("active");
          }

          // ì°œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          likeButton.addEventListener("click", async () => {
            try {
              const likeResponse = await fetch(
                `/api/Products/${productId}/like`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ userId }),
                }
              );
              if (!likeResponse.ok)
                throw new Error("ì°œ ê¸°ëŠ¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");

              const likeData = await likeResponse.json();
              likeCount.textContent = likeData.likes; // ì°œ ìˆ˜ ì—…ë°ì´íŠ¸

              // ë²„íŠ¼ ìƒíƒœ í† ê¸€
              likeButton.classList.toggle("active");
            } catch (error) {
              console.error("ì°œ ê¸°ëŠ¥ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
            }
          });

          const bidButton = document.getElementById("bid-button");
          const bidInput = document.getElementById("bid-amount");

          bidButton.addEventListener("click", () => {
            const bidAmount = parseInt(bidInput.value, 10);

            if (isNaN(bidAmount) || bidAmount <= product.currentPrice) {
              alert(
                `ì…ì°° ê¸ˆì•¡ì€ í˜„ì¬ ê°€ê²©(${product.currentPrice.toLocaleString()}ì›)ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤.`
              );
              return;
            }

            // ì„œë²„ë¡œ ì…ì°° ì •ë³´ ì „ì†¡
            socket.emit("placeBid", { productId, bidAmount, userId });
          });

          // ì„œë²„ë¡œë¶€í„° ì‹¤ì‹œê°„ ê°€ê²© ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
          socket.on("priceUpdate", (data) => {
            if (data.productId === productId) {
              const currentPriceElement =
                document.getElementById("current-price");
              currentPriceElement.textContent = `í˜„ì¬ ê°€ê²©: ${data.currentPrice.toLocaleString()}ì›`;

              // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
              bidInput.value = "";
            }
          });

          // ê²½ë§¤ ì¢…ë£Œ ì•Œë¦¼ ì²˜ë¦¬
          socket.on("auctionEnd", (data) => {
            if (data.productId === productId) {
              alert(
                `ê²½ë§¤ ì¢…ë£Œ! ìµœì¢… ì…ì°°ê°€: ${data.finalPrice.toLocaleString()}ì›, ë‚™ì°°ì: ${
                  data.winner
                }`
              );
            }
          });
        } catch (error) {
          document.getElementById("product-info").innerHTML =
            "ìƒí’ˆ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        }
      });
    </script>
  </body>
</html>
