<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="./public/styles.css" />

    <title>경매 사이트</title>
  </head>
  <body>
    <!-- 로그인 팝업 -->
    <div id="loginPopup" class="login-popup">
      <div>
        <span class="close-btn" onclick="closePopup()">✖</span>
        <form id="loginForm">
          <div class="form-group">
            <input type="text" id="email" placeholder="아이디" required />
          </div>
          <div class="form-group password-group">
            <input
              type="password"
              id="password"
              placeholder="비밀번호"
              required
            />
            <span class="password-toggle" onclick="togglePassword()">👁️</span>
          </div>
          <div class="form-group">
            <button type="submit" class="login-btn">로그인</button>
          </div>
          <!-- 하단 링크 -->
          <div class="links">
            <a href="./public/findid.html">아이디(이메일) 찾기</a> |
            <a href="./public/findid.html">비밀번호 찾기</a> |
            <a href="./public/signup.html">회원가입</a>
          </div>
          <strong>관리자아이디: test@test.com</strong><br />
          <strong>관리자비밀번호: test</strong>
        </form>
      </div>
    </div>
    <!-- 상단 헤더 -->
    <div class="header">
      <!-- 로고 이미지 -->

      <div class="logo-container" onclick="goToMain()">
        <img
          src="./public/images/free-icon-auction-3211435.png"
          alt="Bid Icon"
          class="icon-small"
        />
        <span class="site-title">
          <span>거</span><span>래</span><span>해</span><span>요</span>
          <span>&nbsp;</span>
          <span>경</span><span>매</span><span>의</span><span>숲</span>
        </span>
      </div>

      <!-- 가운데 검색창 -->
      <div class="search-container">
        <input
          type="text"
          id="search-bar"
          class="search-bar"
          placeholder="검색어를 입력하세요"
        />
        <span class="search-icon" onclick="searchProducts()">🔍</span>
      </div>

      <!-- 마이페이지,로그인,상품등록 버튼 -->
      <div class="button-group">
        <button id="register" class="register" onclick="goToRegister()">
          상품 등록
        </button>
        <button class="login-button" onclick="goToLogin()">로그인</button>
        <button class="my-page" onclick="showMyPage()">마이페이지</button>
      </div>
    </div>

    <div class="horizontal-container">
      <div class="left-section">
        <img
          src="./public/images/말풍선.png"
          alt="추가 이미지"
          class="left-image"
        />

        <pre class="overlay-text">
          경매의 숲에서는 다양한 상품을 손쉽게 경매로 
          만나볼 수 있습니다. 자동입찰 기능을 통해 
          더 편리하게 경매에 참여해 보세요!
        </pre>
      </div>

      <img
        src="./public/images/로고.png"
        alt="메인 이미지"
        class="main-image"
      />

      <div class="ranking">
        <div class="ranking-header">
          <h3 class="ranking-title">실시간 랭킹</h3>
          <ul id="ranking-list"></ul>
        </div>
      </div>

      <div class="quiz-footer" onclick="showQuizPopup()">
        <img src="./public/images/퀴즈.png" alt="Quiz Icon" class="quiz-icon" />
        <div class="quiz-text">경매 상식 퀴즈💯</div>
      </div>
    </div>

    <!-- 카테고리 버튼들 -->
    <div class="categories">
      <button class="category-button" onclick="openCategory('의류')">
        <img src="./public/images/의류.jpeg" alt="의류" class="button-image" />
        <span class="button-text">의류</span>
      </button>
      <button class="category-button" onclick="openCategory('가구')">
        <img src="./public/images/가구.jpeg" alt="가구" class="button-image" />
        <span class="button-text">가구</span>
      </button>
      <button class="category-button" onclick="openCategory('식품')">
        <img src="./public/images/식품.jpeg" alt="식품" class="button-image" />
        <span class="button-text">식품</span>
      </button>
      <button class="category-button" onclick="openCategory('가전제품')">
        <img
          src="./public/images/가전제품.jpeg"
          alt="가전제품"
          class="button-image"
        />
        <span class="button-text">가전제품</span>
      </button>
      <button class="category-button" onclick="openCategory('생필품')">
        <img
          src="./public/images/생필품.jpeg"
          alt="생필품"
          class="button-image"
        />
        <span class="button-text">생필품</span>
      </button>
      <button class="category-button" onclick="openCategory('뷰티/미용')">
        <img
          src="./public/images/뷰티미용.jpeg"
          alt="식뷰티/미용"
          class="button-image"
        />
        <span class="button-text">뷰티/미용</span>
      </button>
      <button class="category-button" onclick="openCategory('도서')">
        <img src="./public/images/도서.jpeg" alt="도서" class="button-image" />
        <span class="button-text">도서</span>
      </button>
      <button class="category-button" onclick="openCategory('반려동물용품')">
        <img
          src="./public/images/반려동물용품.jpeg"
          alt="반려동물용품"
          class="button-image"
        />
        <span class="button-text">반려동물용품</span>
      </button>
      <button class="category-button" onclick="openCategory('기타')">
        <img src="./public/images/기타.jpeg" alt="기타" class="button-image" />
        <span class="button-text">기타</span>
      </button>

      <!-- 왼쪽 여백에 물음표 버튼 추가 -->
      <div class="left-sidebar">
        <img
          src="./public/images/물음표.png"
          alt="Icon 1"
          onclick="showPopup('🌳홈 페이지🌳')"
        />
        <div class="text-box">
          <span class="blink-text">물음표를 클릭해보세요!</span>
        </div>
      </div>

      <!-- 팝업창 -->
      <div class="overlay" id="popupOverlay" onclick="hidePopup()"></div>
      <div class="popup" id="popupContent">
        <h2 id="popupText"></h2>
        <p>
          "거래해요 경매의 숲"에 오신 것을 환영합니다. <br />
          여기는 다양한 상품을 손쉽게 거래하고, 재미있는 경매를 즐길 수 있는
          공간입니다! <br />
          <strong>각 페이지마다 물음표 버튼을 클릭해보세요!</strong>
        </p>
        <p><strong>💡 주요 기능</strong></p>
        <ul>
          <li><strong>🛒카테고리 : </strong>다양한 카테고리의 상품 탐색</li>
          <li><strong>📈실시간 랭킹 : </strong>찜 순위로 인기 상품 확인</li>
          <li>
            <strong>🔎상단바 : </strong>상품 등록, 로그인, 마이페이지 이동,
            검색창 이용
          </li>
        </ul>
        <p>지금 바로 거래의 숲에서 특별한 경험을 시작해보세요! 🌟</p>
        <button onclick="hidePopup()">닫기</button>
      </div>
    </div>

    <div
      class="quiz-popup-overlay"
      id="quizPopupOverlay"
      style="display: none"
    ></div>

    <div class="quiz-popup" id="quizPopupContent" style="display: none">
      <h2>Quiz 1</h2>
      <form id="quizForm1">
        <div class="quiz-question">
          <p>
            Q. 다양한 상품들을 쇼핑하고 직접 입찰, 낙찰 기능을 이용하여
            온라인으로 경매에 참여할 수 있는 사이트는 어디인가요?
          </p>
          <div class="quiz-option">
            <label for="answer1-1"
              >1.
              쿠팡&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label
            >
            <input type="radio" name="quizAnswer1" value="1" id="answer1-1" />
          </div>
          <div class="quiz-option">
            <label for="answer1-2"
              >2.
              당근마켓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label
            >
            <input type="radio" name="quizAnswer1" value="2" id="answer1-2" />
          </div>
          <div class="quiz-option">
            <label for="answer1-3">3. 거래해요 경매의 숲</label>
            <input type="radio" name="quizAnswer1" value="3" id="answer1-3" />
          </div>
        </div>
        <div class="quiz-buttons">
          <button type="submit">제출하기</button>
          <button type="button" onclick="hideQuizPopup()">닫기</button>
          <button type="button" onclick="showQuiz2()">다음</button>
        </div>
      </form>
    </div>

    <div class="quiz-popup" id="quizPopupContent2" style="display: none">
      <h2>Quiz 2</h2>
      <form id="quizForm2">
        <div class="quiz-question">
          <p>
            Q. 다수의 사람들이 각자 원하는 금액을 제출하는 경쟁 방법을 무엇이라
            할까요?
          </p>
          <div class="quiz-option">
            <label for="answer2-1">1. 낙찰</label>
            <input type="radio" name="quizAnswer2" value="1" id="answer2-1" />
          </div>
          <div class="quiz-option">
            <label for="answer2-2">2. 유찰</label>
            <input type="radio" name="quizAnswer2" value="2" id="answer2-2" />
          </div>
          <div class="quiz-option">
            <label for="answer2-3">3. 입찰</label>
            <input type="radio" name="quizAnswer2" value="3" id="answer2-3" />
          </div>
        </div>
        <div class="quiz-buttons">
          <button type="submit">제출하기</button>
          <button type="button" onclick="hideQuizPopup()">닫기</button>
          <button type="button" onclick="showQuiz3()">다음</button>
        </div>
      </form>
    </div>

    <div class="quiz-popup" id="quizPopupContent3" style="display: none">
      <h2>Quiz 3</h2>
      <form id="quizForm3">
        <div class="quiz-question">
          <p>
            Q. 경매품 희망자 중 최고가를 제시한 사람을 계약자로 결정하는 것을
            무엇이라 할까요?
          </p>
          <div class="quiz-option">
            <label for="answer3-1">1. 낙찰</label>
            <input type="radio" name="quizAnswer3" value="1" id="answer3-1" />
          </div>
          <div class="quiz-option">
            <label for="answer3-2">2. 응찰</label>
            <input type="radio" name="quizAnswer3" value="2" id="answer3-2" />
          </div>
          <div class="quiz-option">
            <label for="answer3-3">3. 입찰</label>
            <input type="radio" name="quizAnswer3" value="3" id="answer3-3" />
          </div>
        </div>
        <div class="quiz-buttons">
          <button type="submit">제출하기</button>
          <button type="button" onclick="hideQuizPopup()">닫기</button>
          <button type="button" onclick="showQuiz4()">다음</button>
        </div>
      </form>
    </div>

    <div class="quiz-popup" id="quizPopupContent4" style="display: none">
      <h2>Quiz 4</h2>
      <form id="quizForm4">
        <div class="quiz-question">
          <p>Q. 경매에서 낙찰이 되는 시점은 언제일까요?</p>
          <div class="quiz-option">
            <label for="answer4-1"
              >1. 낙찰자가 경매를 종료할
              때&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label
            >
            <input type="radio" name="quizAnswer4" value="1" id="answer4-1" />
          </div>
          <div class="quiz-option">
            <label for="answer4-2"
              >2. 경매 종료시간이 되었을
              때&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label
            >
            <input type="radio" name="quizAnswer4" value="2" id="answer4-2" />
          </div>
          <div class="quiz-option">
            <label for="answer4-3">3. 상품의 입찰가가 원가와 동일해질 때</label>
            <input type="radio" name="quizAnswer4" value="3" id="answer4-3" />
          </div>
        </div>
        <div class="quiz-buttons">
          <button type="submit">제출하기</button>
          <button type="button" onclick="hideQuizPopup()">닫기</button>
        </div>
      </form>
    </div>

    <script>
      // 퀴즈 제출 처리
      let quiz1Submitted = false;
      let quiz2Submitted = false;
      let quiz3Submitted = false;

      function resetQuizState() {
        quiz1Submitted = false;
        quiz2Submitted = false;
        quiz3Submitted = false;
      }

      document
        .getElementById("quizForm1")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // 기본 폼 제출 방지

          const selectedAnswer = document.querySelector(
            'input[name="quizAnswer1"]:checked'
          );
          if (!selectedAnswer) {
            alert("정답을 선택해주세요!");
            return;
          }

          if (selectedAnswer.value === "3") {
            alert("정답입니다! 다음 문제로 이동!");
            quiz1Submitted = true; // 제출 상태를 true로 설정
          } else {
            alert("틀렸습니다. 다시 시도해보세요!");
          }
        });

      // Quiz 2 제출 처리

      document
        .getElementById("quizForm2")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const selectedAnswer = document.querySelector(
            'input[name="quizAnswer2"]:checked'
          );

          if (!selectedAnswer) {
            alert("정답을 선택해주세요!");
            return;
          }

          if (selectedAnswer.value === "3") {
            alert("정답입니다! 다음 문제로 이동!");
            quiz2Submitted = true; // 제출 상태를 true로 설정
          } else {
            alert("틀렸습니다. 다시 시도해보세요!");
          }
        });

      // Quiz 3 제출 처리
      document
        .getElementById("quizForm3")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const selectedAnswer = document.querySelector(
            'input[name="quizAnswer3"]:checked'
          );

          if (!selectedAnswer) {
            alert("정답을 선택해주세요!");
            return;
          }

          if (selectedAnswer.value === "1") {
            alert("정답입니다! 다음 문제로 이동!");
            quiz3Submitted = true; // 제출 상태를 true로 설정
          } else {
            alert("틀렸습니다. 다시 시도해보세요!");
          }
        });

      // Quiz 4 제출 처리
      document
        .getElementById("quizForm4")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          const selectedAnswer = document.querySelector(
            'input[name="quizAnswer4"]:checked'
          );
          if (!selectedAnswer) {
            alert("정답을 선택해주세요!");
            return;
          }

          if (selectedAnswer.value === "2") {
            alert("정답입니다! 이제 경매하러 가볼까요?");
          } else {
            alert("틀렸습니다. 다시 시도해보세요!");
          }
        });

      function showQuizPopup() {
        resetQuizState();
        document.getElementById("quizPopupOverlay").style.display = "block";
        document.getElementById("quizPopupContent").style.display = "block";
        document.getElementById("quizPopupContent2").style.display = "none"; // 두 번째 팝업 숨기기
        document.querySelectorAll("input[type='radio']").forEach((radio) => {
          radio.checked = false;
        });
      }

      function hideQuizPopup() {
        document.getElementById("quizPopupOverlay").style.display = "none";
        document.getElementById("quizPopupContent").style.display = "none";
        document.getElementById("quizPopupContent2").style.display = "none";
        document.getElementById("quizPopupContent3").style.display = "none";
        document.getElementById("quizPopupContent4").style.display = "none";
      }

      function showQuiz2() {
        if (!quiz1Submitted) {
          alert("현재 퀴즈를 제출한 후에만 다음 문제로 이동할 수 있습니다.");
          return;
        }
        document.getElementById("quizPopupContent").style.display = "none"; // 첫 번째 팝업 숨기기
        document.getElementById("quizPopupContent2").style.display = "block"; // 두 번째 팝업 표시
      }

      function showQuiz3() {
        if (!quiz2Submitted) {
          alert("현재 퀴즈를 제출한 후에만 다음 문제로 이동할 수 있습니다.");
          return;
        }
        document.getElementById("quizPopupContent2").style.display = "none"; // 첫 번째 팝업 숨기기
        document.getElementById("quizPopupContent3").style.display = "block"; // 두 번째 팝업 표시
      }

      function showQuiz4() {
        if (!quiz3Submitted) {
          alert("현재 퀴즈를 제출한 후에만 다음 문제로 이동할 수 있습니다.");
          return;
        }
        document.getElementById("quizPopupContent3").style.display = "none"; // 첫 번째 팝업 숨기기
        document.getElementById("quizPopupContent4").style.display = "block"; // 두 번째 팝업 표시
      }

      // 팝업 열기
      function showPopup(content) {
        document.getElementById("popupText").innerText = content;
        document.getElementById("popupOverlay").style.display = "block";
        document.getElementById("popupContent").style.display = "block";
      }

      // 팝업 닫기
      function hidePopup() {
        document.getElementById("popupOverlay").style.display = "none";
        document.getElementById("popupContent").style.display = "none";
      }

      async function loadRealTimeRanking() {
        try {
          const response = await fetch("/api/products/top-likes");
          const products = await response.json();

          const rankingList = document.getElementById("ranking-list");
          rankingList.innerHTML = "";

          products.forEach((product, index) => {
            const listItem = document.createElement("li");
            listItem.className = "ranking-item"; // CSS 클래스 추가
            listItem.innerHTML = `
  <div class="item-content">
    <span>${index + 1}. </span>
    <a href="/productDetails.html?id=${product._id}">${product.name}</a>
  </div>
  <div class="like-container">
    <span class="like-icon">★</span>
    <span class="like-count">${product.likes}</span>
  </div>
`;

            rankingList.appendChild(listItem);
          });
        } catch (error) {
          console.error("실시간 랭킹 데이터를 불러오는 중 오류 발생:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadRealTimeRanking();
        updateAuthButton();
      });
      // 메인 화면으로 돌아가는 함수
      function goToMain() {
        window.location.href = "index.html"; // 메인 페이지로 이동
      }

      // 마이페이지 버튼 클릭 시 리스트 표시
      function showMyPage() {
        // /api/products/add 경로로 GET 요청
        fetch("/api/mypage", {
          method: "GET",
        })
          .then((response) => {
            if (response.ok) {
              // 요청 성공 시 registration.html로 이동
              window.location.href = "./public/mypage.html";
            } else {
              // 요청 실패 시 에러 메시지 처리
              alert("마이 페이지로 이동할 수 없습니다. 로그인이 필요합니다.");
            }
          })
          .catch((error) => {
            console.error("요청 중 오류 발생:", error);
            alert("요청 중 오류가 발생했습니다.");
          });
      }

      // 카테고리 버튼 클릭 시 창 열기
      function openCategory(categoryName) {
        window.location.href = `./public/category.html?category=${encodeURIComponent(
          categoryName
        )}`;
      }

      // Enter 키로 검색
      document
        .getElementById("search-bar")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter") {
            event.preventDefault(); // 기본 동작 방지 (폼 제출 방지)
            searchProducts(); // 검색 함수 호출
          }
        });

      function searchProducts() {
        const query = document.getElementById("search-bar").value.trim();

        if (query) {
          window.location.href = `./public/category.html?search=${encodeURIComponent(
            query
          )}`;
        } else {
          alert("검색어를 입력하세요.");
        }
      }

      function togglePassword() {
        const passwordField = document.getElementById("password");
        const type =
          passwordField.getAttribute("type") === "password"
            ? "text"
            : "password";
        passwordField.setAttribute("type", type);
      }

      // 팝업 열기
      function goToLogin() {
        document.getElementById("loginPopup").style.display = "flex";
      }

      // 팝업 닫기
      function closePopup() {
        document.getElementById("loginPopup").style.display = "none";
      }

      async function updateAuthButton() {
        const authButton = document.querySelector(".login-button");
        const buttonGroup = document.querySelector(".button-group"); // 버튼 그룹

        // 기존 관리자 버튼이 있으면 제거
        const existingAdminButton = document.querySelector(".admin-button");
        if (existingAdminButton) {
          existingAdminButton.remove();
        }

        // 쿠키에서 토큰 추출
        const cookieToken = document.cookie
          .split("; ")
          .find((row) => row.startsWith("token="));
        if (!cookieToken) {
          // 토큰이 없으면 로그인 버튼으로 처리
          authButton.textContent = "로그인";
          authButton.onclick = goToLogin;
          return;
        }

        const token = cookieToken.split("=")[1]; // 토큰 값만 추출

        // 토큰에서 사용자 정보 추출
        const userInfo = parseJwt(token); // JWT 디코딩
        const userId = userInfo?.id; // id 값 추출

        if (userId) {
          authButton.textContent = "로그아웃";
          authButton.onclick = logout;

          try {
            // 서버에서 사용자 정보를 요청
            const response = await fetch(`/api/members/info?userId=${userId}`, {
              method: "GET",
              headers: { "Content-Type": "application/json" },
            });

            if (response.ok) {
              const userData = await response.json();
              console.log(userData);

              if (userData.member.is_admin) {
                // is_admin이 true일 때 관리자 버튼 추가
                if (!document.querySelector(".admin-button")) {
                  const adminButton = document.createElement("button");
                  adminButton.textContent = "관리자 페이지";
                  adminButton.classList.add("admin-button");
                  adminButton.onclick = () => {
                    window.location.href = "/admin.html"; // 관리자 페이지로 이동
                  };
                  buttonGroup.insertBefore(
                    adminButton,
                    document.getElementById("register")
                  ); // 상품등록 버튼 왼쪽에 삽입
                }
              }
            } else {
              console.error("사용자 정보를 가져오는 데 실패했습니다.");
            }
          } catch (error) {
            console.error("사용자 정보 요청 중 오류 발생:", error);
          }
        } else {
          // 로그아웃 상태
          authButton.textContent = "로그인";
          authButton.onclick = goToLogin;
        }
      }

      // JWT 디코딩 함수
      function parseJwt(token) {
        if (!token) {
          console.error("토큰이 비어 있습니다.");
          return null;
        }
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
          return JSON.parse(jsonPayload);
        } catch (error) {
          console.error("JWT 파싱 중 오류 발생:", error);
          return null;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateAuthButton();
      });

      function goToRegister() {
        // /api/products/add 경로로 GET 요청
        fetch("/api/products/add", {
          method: "GET",
        })
          .then((response) => {
            if (response.ok) {
              // 요청 성공 시 registration.html로 이동
              window.location.href = "./public/registration.html";
            } else {
              // 요청 실패 시 에러 메시지 처리
              alert(
                "상품 등록 페이지로 이동할 수 없습니다. 로그인이 필요합니다."
              );
            }
          })
          .catch((error) => {
            console.error("요청 중 오류 발생:", error);
            alert("요청 중 오류가 발생했습니다.");
          });
      }

      function logout() {
        fetch("/api/logout", { method: "POST" })
          .then((response) => {
            if (response.ok) {
              alert("로그아웃 성공");
              updateAuthButton();
            } else {
              throw new Error("로그아웃 실패");
            }
          })
          .catch((error) => console.error("로그아웃 중 오류 발생:", error));
      }

      // 로그인 폼 제출 처리
      document
        .getElementById("loginForm")
        .addEventListener("submit", function (event) {
          event.preventDefault(); // 기본 제출 방지

          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          // 로그인 요청 처리 (예: 서버로 데이터 전송)
          fetch("/api/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          })
            .then((response) => {
              if (response.ok) {
                alert("로그인 성공!");
                closePopup(); // 팝업 닫기
                updateAuthButton();
              } else {
                alert("로그인 실패. 아이디와 비밀번호를 확인하세요.");
              }
            })
            .catch((error) => console.error("로그인 중 오류 발생:", error));
        });
    </script>
  </body>
</html>
